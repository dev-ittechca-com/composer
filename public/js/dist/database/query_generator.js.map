{"version":3,"file":"database/query_generator.js","mappings":"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","sources":["webpack://phpmyadmin/./resources/js/src/database/query_generator.ts","webpack://phpmyadmin/external var \"jQuery\""],"sourcesContent":["import $ from 'jquery';\nimport { escapeBacktick, escapeSingleQuote } from '../modules/functions/escape.ts';\n/**\n * @fileoverview    function used in QBE for DB\n * @name            Database Operations\n *\n * @requires    jQueryUI\n */\n$(document).on('change', '.criteria_op', function () {\n    const op = $(this).val();\n    const criteria = $(this).closest('.table').find('.rhs_text_val');\n    isOpWithoutArg(op) ? criteria.hide().val('') : criteria.show();\n});\nfunction getFormatsText() {\n    return {\n        '=': ' = \\'%s\\'',\n        '>': ' > \\'%s\\'',\n        '>=': ' >= \\'%s\\'',\n        '<': ' < \\'%s\\'',\n        '<=': ' <= \\'%s\\'',\n        '!=': ' != \\'%s\\'',\n        'LIKE': ' LIKE \\'%s\\'',\n        'LIKE %...%': ' LIKE \\'%%%s%%\\'',\n        'NOT LIKE': ' NOT LIKE \\'%s\\'',\n        'NOT LIKE %...%': ' NOT LIKE \\'%%%s%%\\'',\n        'IN (...)': ' IN (%s)',\n        'NOT IN (...)': ' NOT IN (%s)',\n        'BETWEEN': ' BETWEEN \\'%s\\'',\n        'NOT BETWEEN': ' NOT BETWEEN \\'%s\\'',\n        'REGEXP': ' REGEXP \\'%s\\'',\n        'REGEXP ^...$': ' REGEXP \\'^%s$\\'',\n        'NOT REGEXP': ' NOT REGEXP \\'%s\\''\n    };\n}\nfunction opsWithoutArg() {\n    return ['IS NULL', 'IS NOT NULL'];\n}\nfunction opsWithMultipleArgs() {\n    return ['IN (...)', 'NOT IN (...)'];\n}\nfunction isOpWithoutArg(op) {\n    return opsWithoutArg().includes(op);\n}\nfunction acceptsMultipleValues(op) {\n    return opsWithMultipleArgs().includes(op);\n}\nfunction joinWrappingElementsWith(array, char, separator = ',') {\n    let string = '';\n    array.forEach(function (option, index) {\n        string += `${char}${option}${char}`;\n        if (index !== array.length - 1) {\n            string += separator;\n        }\n    });\n    return string;\n}\nfunction generateCondition(criteriaDiv, table) {\n    const tableName = table.val();\n    const tableAlias = table.siblings('.table_alias').val();\n    const criteriaOp = criteriaDiv.find('.criteria_op').first().val();\n    let criteriaText = criteriaDiv.find('.rhs_text_val').first().val();\n    let query = '`' + escapeBacktick(tableAlias === '' ? tableName : tableAlias) + '`.';\n    query += '`' + escapeBacktick(table.parent().find('.opColumn').first().val()) + '`';\n    if (criteriaDiv.find('.criteria_rhs').first().val() === 'text') {\n        if (isOpWithoutArg(criteriaOp)) {\n            query += ' ' + criteriaOp;\n        }\n        else if (acceptsMultipleValues(criteriaOp)) {\n            const formatsText = getFormatsText();\n            const valuesInputs = criteriaDiv.find('input.val');\n            let critertiaTextArray = [];\n            valuesInputs.each(function () {\n                let value = escapeSingleQuote($(this).val());\n                if (!critertiaTextArray.includes(value)) {\n                    critertiaTextArray.push(value);\n                }\n            });\n            criteriaText = joinWrappingElementsWith(critertiaTextArray, '\\'');\n            query += window.sprintf(formatsText[criteriaOp], criteriaText);\n        }\n        else {\n            const formatsText = getFormatsText();\n            query += window.sprintf(formatsText[criteriaOp], criteriaText);\n        }\n    }\n    else {\n        query += ' ' + criteriaOp;\n        query += ' `' + escapeBacktick(criteriaDiv.find('.tableNameSelect').first().val()) + '`.';\n        query += '`' + escapeBacktick(criteriaDiv.find('.opColumn').first().val()) + '`';\n    }\n    return query;\n}\nfunction generateWhereBlock() {\n    var count = 0;\n    var query = '';\n    $('.tableNameSelect').each(function () {\n        var criteriaDiv = $(this).siblings('.jsCriteriaOptions').first();\n        var useCriteria = $(this).siblings('.criteria_col').first();\n        if ($(this).val() !== '' && useCriteria.prop('checked')) {\n            if (count > 0) {\n                criteriaDiv.find('input.logical_op').each(function () {\n                    if ($(this).prop('checked')) {\n                        query += ' ' + $(this).val() + ' ';\n                    }\n                });\n            }\n            query += generateCondition(criteriaDiv, $(this));\n            count++;\n        }\n    });\n    return query;\n}\nfunction generateJoin(newTable, tableAliases, fk) {\n    var query = '';\n    query += ' \\n\\tLEFT JOIN ' + '`' + escapeBacktick(newTable) + '`';\n    if (tableAliases[fk.TABLE_NAME][0] !== '') {\n        query += ' AS `' + escapeBacktick(tableAliases[newTable][0]) + '`';\n        query += ' ON `' + escapeBacktick(tableAliases[fk.TABLE_NAME][0]) + '`';\n    }\n    else {\n        query += ' ON `' + escapeBacktick(fk.TABLE_NAME) + '`';\n    }\n    query += '.`' + fk.COLUMN_NAME + '`';\n    if (tableAliases[fk.REFERENCED_TABLE_NAME][0] !== '') {\n        query += ' = `' + escapeBacktick(tableAliases[fk.REFERENCED_TABLE_NAME][0]) + '`';\n    }\n    else {\n        query += ' = `' + escapeBacktick(fk.REFERENCED_TABLE_NAME) + '`';\n    }\n    query += '.`' + fk.REFERENCED_COLUMN_NAME + '`';\n    return query;\n}\nfunction existReference(table, fk, usedTables) {\n    var isReferredBy = fk.TABLE_NAME === table && usedTables.includes(fk.REFERENCED_TABLE_NAME);\n    var isReferencedBy = fk.REFERENCED_TABLE_NAME === table && usedTables.includes(fk.TABLE_NAME);\n    return isReferredBy || isReferencedBy;\n}\nfunction tryJoinTable(table, tableAliases, usedTables, foreignKeys) {\n    for (var i = 0; i < foreignKeys.length; i++) {\n        var fk = foreignKeys[i];\n        if (existReference(table, fk, usedTables)) {\n            return generateJoin(table, tableAliases, fk);\n        }\n    }\n    return '';\n}\nfunction appendTable(table, tableAliases, usedTables, foreignKeys) {\n    var query = tryJoinTable(table, tableAliases, usedTables, foreignKeys);\n    if (query === '') {\n        if (usedTables.length > 0) {\n            query += '\\n\\t, ';\n        }\n        query += '`' + escapeBacktick(table) + '`';\n        if (tableAliases[table][0] !== '') {\n            query += ' AS `' + escapeBacktick(tableAliases[table][0]) + '`';\n        }\n    }\n    usedTables.push(table);\n    return query;\n}\nfunction generateFromBlock(tableAliases, foreignKeys) {\n    var usedTables = [];\n    var query = '';\n    for (var table in tableAliases) {\n        if (tableAliases.hasOwnProperty(table)) {\n            query += appendTable(table, tableAliases, usedTables, foreignKeys);\n        }\n    }\n    return query;\n}\nwindow.generateWhereBlock = generateWhereBlock;\nwindow.generateFromBlock = generateFromBlock;\n","module.exports = jQuery;"],"names":["$","escapeBacktick","escapeSingleQuote","document","on","op","val","criteria","closest","find","isOpWithoutArg","hide","show","getFormatsText","opsWithoutArg","opsWithMultipleArgs","includes","acceptsMultipleValues","joinWrappingElementsWith","array","char","separator","arguments","length","undefined","string","forEach","option","index","concat","generateCondition","criteriaDiv","table","tableName","tableAlias","siblings","criteriaOp","first","criteriaText","query","parent","formatsText","valuesInputs","critertiaTextArray","each","value","push","window","sprintf","generateWhereBlock","count","useCriteria","prop","generateJoin","newTable","tableAliases","fk","TABLE_NAME","COLUMN_NAME","REFERENCED_TABLE_NAME","REFERENCED_COLUMN_NAME","existReference","usedTables","isReferredBy","isReferencedBy","tryJoinTable","foreignKeys","i","appendTable","generateFromBlock","hasOwnProperty"],"sourceRoot":""}