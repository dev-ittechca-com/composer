{"version":3,"file":"database/query_generator.js","mappings":"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","sources":["webpack://phpmyadmin/./resources/js/src/database/query_generator.ts","webpack://phpmyadmin/external var \"jQuery\""],"sourcesContent":["import $ from 'jquery';\nimport { escapeBacktick, escapeSingleQuote } from '../modules/functions/escape.ts';\n/**\n * @fileoverview    function used in QBE for DB\n * @name            Database Operations\n *\n * @requires    jQueryUI\n */\n$(document).on('change', '.criteria_op', function () {\n    const op = $(this).val();\n    const criteria = $(this).closest('.table').find('.rhs_text_val');\n    isOpWithoutArg(op) ? criteria.hide().val('') : criteria.show();\n});\nfunction getFormatsText() {\n    return {\n        '=': ' = \\'%s\\'',\n        '>': ' > \\'%s\\'',\n        '>=': ' >= \\'%s\\'',\n        '<': ' < \\'%s\\'',\n        '<=': ' <= \\'%s\\'',\n        '!=': ' != \\'%s\\'',\n        'LIKE': ' LIKE \\'%s\\'',\n        'LIKE %...%': ' LIKE \\'%%%s%%\\'',\n        'NOT LIKE': ' NOT LIKE \\'%s\\'',\n        'NOT LIKE %...%': ' NOT LIKE \\'%%%s%%\\'',\n        'IN (...)': ' IN (%s)',\n        'NOT IN (...)': ' NOT IN (%s)',\n        'BETWEEN': ' BETWEEN \\'%s\\'',\n        'NOT BETWEEN': ' NOT BETWEEN \\'%s\\'',\n        'REGEXP': ' REGEXP \\'%s\\'',\n        'REGEXP ^...$': ' REGEXP \\'^%s$\\'',\n        'NOT REGEXP': ' NOT REGEXP \\'%s\\''\n    };\n}\nfunction opsWithoutArg() {\n    return ['IS NULL', 'IS NOT NULL'];\n}\nfunction isOpWithoutArg(op) {\n    return opsWithoutArg().includes(op);\n}\nfunction generateCondition(criteriaDiv, table) {\n    const tableName = table.val();\n    const tableAlias = table.siblings('.table_alias').val();\n    const criteriaOp = criteriaDiv.find('.criteria_op').first().val();\n    let criteriaText = criteriaDiv.find('.rhs_text_val').first().val();\n    let query = '`' + escapeBacktick(tableAlias === '' ? tableName : tableAlias) + '`.';\n    query += '`' + escapeBacktick(table.parent().find('.opColumn').first().val()) + '`';\n    if (criteriaDiv.find('.criteria_rhs').first().val() === 'text') {\n        if (isOpWithoutArg(criteriaOp)) {\n            query += ' ' + criteriaOp;\n        }\n        else {\n            const formatsText = getFormatsText();\n            if (!['IN (...)', 'NOT IN (...)'].includes(criteriaOp)) {\n                criteriaText = escapeSingleQuote(criteriaText);\n            }\n            query += window.sprintf(formatsText[criteriaOp], criteriaText);\n        }\n    }\n    else {\n        query += ' ' + criteriaOp;\n        query += ' `' + escapeBacktick(criteriaDiv.find('.tableNameSelect').first().val()) + '`.';\n        query += '`' + escapeBacktick(criteriaDiv.find('.opColumn').first().val()) + '`';\n    }\n    return query;\n}\nfunction generateWhereBlock() {\n    var count = 0;\n    var query = '';\n    $('.tableNameSelect').each(function () {\n        var criteriaDiv = $(this).siblings('.jsCriteriaOptions').first();\n        var useCriteria = $(this).siblings('.criteria_col').first();\n        if ($(this).val() !== '' && useCriteria.prop('checked')) {\n            if (count > 0) {\n                criteriaDiv.find('input.logical_op').each(function () {\n                    if ($(this).prop('checked')) {\n                        query += ' ' + $(this).val() + ' ';\n                    }\n                });\n            }\n            query += generateCondition(criteriaDiv, $(this));\n            count++;\n        }\n    });\n    return query;\n}\nfunction generateJoin(newTable, tableAliases, fk) {\n    var query = '';\n    query += ' \\n\\tLEFT JOIN ' + '`' + escapeBacktick(newTable) + '`';\n    if (tableAliases[fk.TABLE_NAME][0] !== '') {\n        query += ' AS `' + escapeBacktick(tableAliases[newTable][0]) + '`';\n        query += ' ON `' + escapeBacktick(tableAliases[fk.TABLE_NAME][0]) + '`';\n    }\n    else {\n        query += ' ON `' + escapeBacktick(fk.TABLE_NAME) + '`';\n    }\n    query += '.`' + fk.COLUMN_NAME + '`';\n    if (tableAliases[fk.REFERENCED_TABLE_NAME][0] !== '') {\n        query += ' = `' + escapeBacktick(tableAliases[fk.REFERENCED_TABLE_NAME][0]) + '`';\n    }\n    else {\n        query += ' = `' + escapeBacktick(fk.REFERENCED_TABLE_NAME) + '`';\n    }\n    query += '.`' + fk.REFERENCED_COLUMN_NAME + '`';\n    return query;\n}\nfunction existReference(table, fk, usedTables) {\n    var isReferredBy = fk.TABLE_NAME === table && usedTables.includes(fk.REFERENCED_TABLE_NAME);\n    var isReferencedBy = fk.REFERENCED_TABLE_NAME === table && usedTables.includes(fk.TABLE_NAME);\n    return isReferredBy || isReferencedBy;\n}\nfunction tryJoinTable(table, tableAliases, usedTables, foreignKeys) {\n    for (var i = 0; i < foreignKeys.length; i++) {\n        var fk = foreignKeys[i];\n        if (existReference(table, fk, usedTables)) {\n            return generateJoin(table, tableAliases, fk);\n        }\n    }\n    return '';\n}\nfunction appendTable(table, tableAliases, usedTables, foreignKeys) {\n    var query = tryJoinTable(table, tableAliases, usedTables, foreignKeys);\n    if (query === '') {\n        if (usedTables.length > 0) {\n            query += '\\n\\t, ';\n        }\n        query += '`' + escapeBacktick(table) + '`';\n        if (tableAliases[table][0] !== '') {\n            query += ' AS `' + escapeBacktick(tableAliases[table][0]) + '`';\n        }\n    }\n    usedTables.push(table);\n    return query;\n}\nfunction generateFromBlock(tableAliases, foreignKeys) {\n    var usedTables = [];\n    var query = '';\n    for (var table in tableAliases) {\n        if (tableAliases.hasOwnProperty(table)) {\n            query += appendTable(table, tableAliases, usedTables, foreignKeys);\n        }\n    }\n    return query;\n}\nwindow.generateWhereBlock = generateWhereBlock;\nwindow.generateFromBlock = generateFromBlock;\n","module.exports = jQuery;"],"names":["$","escapeBacktick","escapeSingleQuote","document","on","op","val","criteria","closest","find","isOpWithoutArg","hide","show","getFormatsText","opsWithoutArg","includes","generateCondition","criteriaDiv","table","tableName","tableAlias","siblings","criteriaOp","first","criteriaText","query","parent","formatsText","window","sprintf","generateWhereBlock","count","each","useCriteria","prop","generateJoin","newTable","tableAliases","fk","TABLE_NAME","COLUMN_NAME","REFERENCED_TABLE_NAME","REFERENCED_COLUMN_NAME","existReference","usedTables","isReferredBy","isReferencedBy","tryJoinTable","foreignKeys","i","length","appendTable","push","generateFromBlock","hasOwnProperty"],"sourceRoot":""}